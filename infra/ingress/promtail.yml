server:
  http_listen_port: {{ env "NOMAD_PORT_promtail" }}
  grpc_listen_port: 0

positions:
  filename: {{ env "NOMAD_ALLOC_DIR" }}/data/positions.yml

client:
  url: https://loki-distributor.service.consul/loki/api/v1/push

  tls_config:
    insecure_skip_verify: true

scrape_configs:
  - job_name: "traefik"
    static_configs:
    - labels:
        source: "ingress"
        __path__: {{ env "NOMAD_ALLOC_DIR" }}/data/access.log
    pipeline_stages:
      - json:
          expressions:
            time: time
            level: level
            method: RequestMethod
            status: DownstreamStatus
            path: RequestPath
      - labels:
          method:
          status:
      - timestamp:
          source: time
          format: "RFC3339"
      - drop:
          source: path
          expression: "/ping"
      - drop:
          source: path
          expression: "/metrics"
