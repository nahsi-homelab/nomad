global:
  scrape_interval: "10s"

scrape_configs:
  - job_name: "vmagent"
    metrics_path: "/metrics"
    consul_sd_configs:
      - server: "http://172.26.64.1:8500"
        services:
          - "vmagent"
    relabel_configs:
      - source_labels: ["__meta_consul_service_metadata_alloc_id"]
        target_label: "instance"
      - source_labels: ["__address__"]
        target_label: "__address__"
        regex: '{{ env "NOMAD_ADDR_http" }}'
        replacement: "127.0.0.1:8429"

  - job_name: "victoria-metrics"
    consul_sd_configs:
      - server: "http://172.26.64.1:8500"
        services:
          - "victoria-metrics"
    relabel_configs:
      - source_labels: ["__meta_consul_node"]
        target_label: "instance"

  - job_name: "consul"
    metrics_path: "/v1/agent/metrics"
    params:
      format: ["prometheus"]
    consul_sd_configs:
      - server: "http://172.26.64.1:8500"
        services:
          - "consul-api"
    relabel_configs:
      - source_labels: ["__meta_consul_node"]
        target_label: "instance"
      - source_labels: ["__meta_consul_service_metadata_dc"]
        target_label: "dc"

  - job_name: "nomad"
    metrics_path: "/v1/metrics"
    params:
      format: ["prometheus"]
    consul_sd_configs:
      - server: "http://172.26.64.1:8500"
        services:
          - "nomad-api"
    relabel_configs:
      - source_labels: ["__meta_consul_node"]
        target_label: "instance"
      - source_labels: ["__meta_consul_service_metadata_dc"]
        target_label: "dc"

  - job_name: "vault"
    scheme: "https"
    tls_config:
      ca_file: "/secrets/certs/CA.pem"
    follow_redirects: true
    metrics_path: "/v1/sys/metrics"
    params:
      format: ["prometheus"]
    authorization:
      credentials_file: "/secrets/vault_token"
    static_configs:
      - targets:
        - "vault.service.consul"

  - job_name: "telegraf-exporter"
    consul_sd_configs:
      - server: "http://172.26.64.1:8500"
        services:
          - "telegraf-exporter"
    relabel_configs:
      - source_labels: ["__meta_consul_node"]
        target_label: "instance"

  - job_name: "traefik"
    consul_sd_configs:
      - server: "http://172.26.64.1:8500"
        services:
          - "traefik"
    relabel_configs:
      - source_labels: ["__meta_consul_node"]
        target_label: "instance"

  - job_name: "ingress"
    consul_sd_configs:
      - server: "http://172.26.64.1:8500"
        services:
          - "ingress"
    relabel_configs:
      - source_labels: ["__meta_consul_node"]
        target_label: "instance"

  - job_name: "grafana"
    consul_sd_configs:
      - server: "http://172.26.64.1:8500"
        services:
          - "grafana"
    relabel_configs:
      - source_labels: ["__meta_consul_service_metadata_alloc_id"]
        target_label: "instance"

  - job_name: "postgres-exporter"
    consul_sd_configs:
      - server: "http://172.26.64.1:8500"
        services:
          - "postgres-exporter"
    relabel_configs:
      - source_labels: ["__meta_consul_service"]
        target_label: "instance"

  - job_name: "patroni"
    scheme: "https"
    tls_config:
      ca_file: "/secrets/certs/CA.pem"
    consul_sd_configs:
      - server: "http://172.26.64.1:8500"
        services:
          - "patroni"
    relabel_configs:
      - source_labels: ["__meta_consul_service_metadata_alloc_id"]
        target_label: "instance"

  - job_name: "mongo-exporter"
    consul_sd_configs:
      - server: "http://172.26.64.1:8500"
        services:
          - "mongo-exporter"
    relabel_configs:
      - source_labels: ["__meta_consul_service_metadata_alloc_id"]
        target_label: "instance"

  - job_name: "minio-job"
    bearer_token_file: "/secrets/minio-token"
    metrics_path: "/minio/v2/metrics/cluster"
    scheme: "https"
    static_configs:
      - targets:
         - "s3.nahsi.dev"
    relabel_configs:
      - source_labels: ["__address__"]
        target_label: "instance"

  - job_name: "network-exporter"
    consul_sd_configs:
      - server: "http://172.26.64.1:8500"
        services:
          - "network-exporter"
    relabel_configs:
      - source_labels: ["__meta_consul_service_metadata_dc"]
        target_label: "instance"

  - job_name: "envoy"
    consul_sd_configs:
      - server: "http://172.26.64.1:8500"
    relabel_configs:
      - source_labels: ["job"]
        target_label: "instance"
      - source_labels: ["__meta_consul_service"]
        action: "drop"
        regex: '(.+)-sidecar-proxy'
      - source_labels: ["__meta_consul_service_metadata_envoy"]
        action: "keep"
        regex: '(.+)'
      - source_labels: ["__address__, __meta_consul_service_metadata_envoy"]
        regex: '([^:]+)(?::\d+)?;(\d+)'
        replacement: '${1}:${2}'
        target_label: "__address__"
    metric_relabel_configs:
      - source_labels: ["__name__"]
        regex: "(envoy_cluster_upstream_rq_connect_fail|envoy_http_downstream_rq_no_route|envoy_cluster_upstream_rq_completed|envoy_http_downstream_rq_completed|envoy_cluster_upstream_rq_time_bucket|envoy_http_downstream_rq_time_bucket|envoy_cluster_upstream_rq_xx|envoy_http_downstream_rq_xx|envoy_listener_http_downstream_rq_xx|envoy_cluster_upstream_cx_connect_fail|envoy_tcp_downstream_cx_no_route|envoy_cluster_upstream_cx_rx_bytes_total|envoy_cluster_upstream_cx_tx_bytes_total|envoy_tcp_downstream_cx_tx_bytes_total|envoy_tcp_downstream_cx_rx_bytes_total)"
        action: "keep"

  - job_name: "envoy-vmagent"
    static_configs:
      - targets:
        - "127.0.0.1:9102"
    relabel_configs:
      - source_labels: ["job"]
        target_label: "instance"
    metric_relabel_configs:
      - source_labels: ["__name__"]
        regex: "(envoy_cluster_upstream_rq_connect_fail|envoy_http_downstream_rq_no_route|envoy_cluster_upstream_rq_completed|envoy_http_downstream_rq_completed|envoy_cluster_upstream_rq_time_bucket|envoy_http_downstream_rq_time_bucket|envoy_cluster_upstream_rq_xx|envoy_http_downstream_rq_xx|envoy_listener_http_downstream_rq_xx|envoy_cluster_upstream_cx_connect_fail|envoy_tcp_downstream_cx_no_route|envoy_cluster_upstream_cx_rx_bytes_total|envoy_cluster_upstream_cx_tx_bytes_total|envoy_tcp_downstream_cx_tx_bytes_total|envoy_tcp_downstream_cx_rx_bytes_total)"
        action: "keep"
