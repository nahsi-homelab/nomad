version: 1

global:
  server_name: matrix.service.consul

  private_key: "/secrets/matrix.key"
  key_validity_period: 48h0m0s

  trusted_third_party_id_servers:
  - matrix.org
  - vector.im

  kafka:
    addresses:
      - "kafka-1.service.consul:9094"
      - "kafka-2.service.consul:9094"
      - "kafka-3.service.consul:9094"

    topic_prefix: Dendrite
    use_naffka: false

  metrics:
    enabled: true

app_service_api:
  internal_api:
    listen: http://127.0.0.1:7777
    connect: http://127.0.0.1:7777
  database:
    connection_string: postgresql://dendrite:
      {{- with secret "database/static-creds/dendrite" -}}
      {{ .Data.password }}{{ end -}}
      @master.postgres.service.consul/dendrite?sslmode=disable
    max_open_conns: 10
    max_idle_conns: 2
    conn_max_lifetime: -1

  # Appservice configuration files to load into this homeserver.
  config_files: []

client_api:
  internal_api:
    listen: http://127.0.0.1:7771
    connect: http://127.0.0.1:7771
  external_api:
    listen: http://127.0.0.1:8071

  registration_disabled: false
  registration_shared_secret: {{ with secret "secret/dendrite/registration-key" }}{{ .Data.data.key }}{{ end }}
  enable_registration_captcha: false

  rate_limiting:
    enabled: true
    threshold: 5
    cooloff_ms: 500

edu_server:
  internal_api:
    listen: http://127.0.0.1:7778
    connect: http://127.0.0.1:7778

federation_api:
  internal_api:
    listen: http://127.0.0.1:7772
    connect: http://127.0.0.1:7772
  external_api:
    listen: http://127.0.0.1:8072

  federation_certificates: []

federation_sender:
  internal_api:
    listen: http://127.0.0.1:7775
    connect: http://127.0.0.1:7775
  database:
    connection_string: postgresql://dendrite:
      {{- with secret "database/static-creds/dendrite" -}}
      {{ .Data.password }}{{ end -}}
      @master.postgres.service.consul/dendrite?sslmode=disable
    max_open_conns: 10
    max_idle_conns: 2
    conn_max_lifetime: -1

  send_max_retries: 16

  disable_tls_validation: false

key_server:
  internal_api:
    listen: http://127.0.0.1:7779
    connect: http://127.0.0.1:7779
  database:
    connection_string: postgresql://dendrite:
      {{- with secret "database/static-creds/dendrite" -}}
      {{ .Data.password }}{{ end -}}
      @master.postgres.service.consul/dendrite?sslmode=disable
    max_open_conns: 10
    max_idle_conns: 2
    conn_max_lifetime: -1

media_api:
  internal_api:
    listen: http://127.0.0.1:7774
    connect: http://127.0.0.1:7774
  external_api:
    listen: http://127.0.0.1:8074
  database:
    connection_string: postgresql://dendrite:
      {{- with secret "database/static-creds/dendrite" -}}
      {{ .Data.password }}{{ end -}}
      @master.postgres.service.consul/dendrite?sslmode=disable
    max_open_conns: 10
    max_idle_conns: 2
    conn_max_lifetime: -1

  base_path: /alloc/data/media

  max_file_size_bytes: 10485760
  dynamic_thumbnails: true
  max_thumbnail_generators: 10

  thumbnail_sizes:
  - width: 32
    height: 32
    method: crop
  - width: 96
    height: 96
    method: crop
  - width: 640

room_server:
  internal_api:
    listen: http://127.0.0.1:7770
    connect: http://127.0.0.1:7770
  database:
    connection_string: postgresql://dendrite:
      {{- with secret "database/static-creds/dendrite" -}}
      {{ .Data.password }}{{ end -}}
      @master.postgres.service.consul/dendrite?sslmode=disable
    max_open_conns: 10
    max_idle_conns: 2
    conn_max_lifetime: -1

signing_key_server:
  internal_api:
    listen: http://127.0.0.1:7780
    connect: http://127.0.0.1:7780
  database:
    connection_string: postgresql://dendrite:
      {{- with secret "database/static-creds/dendrite" -}}
      {{ .Data.password }}{{ end -}}
      @master.postgres.service.consul/dendrite?sslmode=disable
    max_open_conns: 10
    max_idle_conns: 2
    conn_max_lifetime: -1

  key_perspectives:
  - server_name: matrix.org
    keys:
    - key_id: ed25519:auto
      public_key: Noi6WqcDj0QmPxCNQqgezwTlBKrfqehY1u2FyWP9uYw
    - key_id: ed25519:a_RXGa
      public_key: l8Hft5qXKn1vfHrg3p4+W8gELQVo8N13JkluMfmn2sQ
      
  prefer_direct_fetch: false

sync_api:
  internal_api:
    listen: http://127.0.0.1:7773
    connect: http://127.0.0.1:7773
  external_api:
    listen: http://127.0.0.1:8073
  database:
    connection_string: postgresql://dendrite:
      {{- with secret "database/static-creds/dendrite" -}}
      {{ .Data.password }}{{ end -}}
      @master.postgres.service.consul/dendrite?sslmode=disable
    max_open_conns: 10
    max_idle_conns: 2
    conn_max_lifetime: -1

user_api:
  internal_api:
    listen: http://127.0.0.1:7781
    connect: http://127.0.0.1:7781
  account_database:
    connection_string: postgresql://dendrite:
      {{- with secret "database/static-creds/dendrite" -}}
      {{ .Data.password }}{{ end -}}
      @master.postgres.service.consul/dendrite?sslmode=disable
    max_open_conns: 10
    max_idle_conns: 2
    conn_max_lifetime: -1
  device_database:
    connection_string: postgresql://dendrite:
      {{- with secret "database/static-creds/dendrite" -}}
      {{ .Data.password }}{{ end -}}
      @master.postgres.service.consul/dendrite?sslmode=disable
    max_open_conns: 10
    max_idle_conns: 2
    conn_max_lifetime: -1

logging:
- type: file
  level: info
  params:
    path: /alloc/data/logs

tracing:
  enabled: true
  jaeger:
    serviceName: "dendrite"
    disabled: false
    rpc_metrics: true
    tags: []
    sampler:
      type: const
      param: 1
